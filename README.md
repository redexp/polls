# Соціологічна служба Черкаського інституту міста

Цим проєктом Громадська організація «Черкаський інститут міста» започатковує новий підхід до проведення соціологічних досліджень, які з часом мають замінити старі методи вивчення громадської думки.

Завдяки цифровим інструментам соціологічні дослідження можуть стати:

- Більш масовими, а отже — якіснішими, з меншими статистичними похибками, краще відображати суспільну думку, бо тепер опитуваннями легше досягти радикально більшої аудиторії
- Дешевшими та швидшими, бо вже не потрібно утримувати великі команди інтерв’юерів, зустрічатися з опитуваними особисто і вручну аналізувати анкети
- Достовірнішими, бо застосування цифрового підпису та інших цифрових ідентифікаторів унеможливлює наданя неправдивих даних людьми, які погодилися взяти участь в опитуванні, та відсіює людей, які не є цільовою групою опитування за місцем проживання, дозволяє уникнути фальшування, дублювання опитувальників

## Основі можливості

- Декілька варіантів відповіді з можливістю обрати один чи декілька варіантів.
- Ідентифікація через [BankID](https://bank.gov.ua/ua/bank-id-nbu) унеможливлює створення фальшивих відповідей.
- Опціональне обмеження для участі у опитуваннях по місцю проживання (наприклад тільки у місті Черкаси).
- Окремі опитування можуть містити (за попереднім попередженням і згодою опитуваних) список імен тих, хто взяв участь в опитуванні, для того, щоб результати таких опитувань могли виконувати роль легальної, достовірної публічної демонстрації громадянської позиції на зразок петицій, які надалі можуть бути передані до органів місцевого самоврядування для відповідного реагування.

## Обмеження

- По місцю реєстрації у місцевості вказаній у конфігурації.
- Відповіді змінювати можливо лише на протязі 10 хвилин.

## Технічні характеристики

- Відсутність будь-якої адмін панелі, що зменшує ризик зламу.
- Питання пишуться вручну у форматі [md](https://uk.wikipedia.org/wiki/Markdown), автоматично створюються статичні html файли за допомогою фреймворка [Astro](https://astro.build)
- Динамічна частина сайту написана на TypeScript і _без_ використання бібліотек типу React. Причини:
  - На сайті нема складної логіки - буквально форми і запити
  - В такому коді розбереться буквально буть-хто, з будь-яким бекграундом
- Відповіді зберігаються на сервері у базі даних [SQLite](https://sqlite.org) разом з ім'ям, та ідентифікатором [BankID](https://bank.gov.ua/ua/bank-id-nbu) громадянина. 
- Окремо від імені (тобто анонімно), зберігається вік, стать та район міста (у форматі [Plus Code](https://uk.wikipedia.org/wiki/Відкритий_код_розташування) тобто не точна адреса, а приблизне місце розташування) того хто залишив відповідь для статистичних висновків.
- Запити від браузера обробляються сервером [Express](https://expressjs.com)
- Сервер не використовує cookie. Замість цього використовується технологія [JWT](https://jwt.io)

## Запуск проєкту у режимі розробки

1. Скопіюйте проєкт `git clone git@github.com:redexp/polls.git && cd polls`
2. Встановіть пакети `npm install` або `pnpm install` (саме lock файл [pnpm](https://pnpm.io/installation) знаходиться у проєкті)
3. Створіть актуальну базу даних `npm run migrate`. Буде створено файл `database.sqlite`.
4. Створіть ключі для шифрування статистичних даних `npm run keys`. Ключ `statistic_private_key.pem` треба перемістити у безпечне місце окремо від цього проєкту.
5. Запустіть astro фреймворк `npm start`
6. Запустіть сервер API `npm run server`
7. Запустіть сервер який вдає BankID `npm run bankid`
8. Відкрийте сторінку http://localhost:4321

## Налаштування

Налаштування серверу API знаходяться у файлі `server/config.js`. Усі налаштування можуть бути переписані змінними середовища. Наприклад наступні налаштування
```js
const config = {
	bankid: {
		dev_port: 8001,
		url: '',
		client_id: '',
		client_secret: '',
		dataset: 51,
	},
    //...
};
```
Можут бути переписані змінними середовища `BANKID_DEV_PORT`, `BANKID_URL`, `BANKID_CLIENT_ID` і т.д. Також ви можете створити файл `.env`.

### Maps

Для того, щоб сгенерувати [Plus Code](https://uk.wikipedia.org/wiki/Відкритий_код_розташування) з адреси - необхідний сервіс, який дасть координати (у вигляді latitude та longitude) з цієї адреси, а вже потім вони перетворюються на код у вигляді `8GXJC3V5+`. На даний момент сервіс [Mapbox](https://mapbox.com) дає можливість робити до 100 000 запитів на місяць безкоштовно, в той час як Google Maps API дає лише 10 000. Тому наразі використовується цей сервіс. Все що потрібно - це створити `access_token`.

## Запуск проєкту у робочому режимі

1. Сгенеруйте статичні файли `npm run build`. Будуть створені файли у папці `dist`. Як правило їх копіюють в папку `public` на веб сервері і налаштовують `nginx` для того щоб він їх віддавав.
2. Скопіюйте папку `server` на ваш веб сервер і запустіть `node server/index.js`

## Редагування опитувань

Усі опитування мають бути у папці `src/polls` у форматі [md](https://uk.wikipedia.org/wiki/Markdown). В цій же папці ви знайдете приклади опитувань.

На початку кожного файлу ви можете вказати налаштування дати закінчення опитування `expire: 2025-12-31` та чи є опитуванння публічним (тобто чи зберігати імʼя разом з відповіддю) `public: true` (за замовченням опитування анонімні)

Імʼя файла - це ідентифікатор опитування у базі даних, тож не змінюйте його у процесі збору відповідей.

